<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RNLI Launch Archive</title>
  <style>
    :root{
      --bg:#0b0f14;--card:#ffffff0f;--border:#ffffff1a;--muted:#ffffff80;--muted2:#ffffff66;--brand:#f59e0b;--ok:#22c55e;--warn:#eab308;--danger:#ef4444;--link:#f28b00;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 48px}
    h1{margin:0 0 6px;font-size:clamp(24px,3.5vw,34px);letter-spacing:-.01em}
    .sub{color:var(--muted2);margin-bottom:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 18px}
    input[type="text"]{background:#ffffff0d;border:1px solid var(--border);color:#fff;border-radius:12px;padding:10px 12px;outline:none;min-width:260px}
    .seg{display:flex;border:1px solid var(--border);background:#ffffff08;border-radius:12px;overflow:hidden}
    .seg button{padding:8px 12px;background:transparent;color:#fff;border:none;cursor:pointer}
    .seg button.active{background:#ffffff12}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .title{font-size:22px;font-weight:700;margin:2px 0 8px}
    .meta{display:flex;justify-content:space-between;gap:10px;color:var(--muted2);font-size:13px}
    .desc{color:#ffffffcc;font-size:15px;margin-top:6px}
    .row2{display:flex;justify-content:space-between;align-items:center;color:var(--muted2);font-size:13px;margin-top:10px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;background:#64748b}
    a{color:var(--link);text-decoration:none}
    .alert{margin:10px 0;border:1px solid #ef444455;background:#ef44441a;color:#fecaca;border-radius:12px;padding:10px 12px}
    .pager{display:flex;gap:10px;margin-top:16px}
    .btn{background:#ffffff0d;border:1px solid var(--border);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
  </style>
</head>
<body>
<div class="container">
  <h1>RNLI Launch Archive</h1>
  <div class="sub">Older launches saved automatically from the live board.</div>

  <div id="error" class="alert" style="display:none"></div>

  <div class="toolbar">
    <input id="q" type="text" placeholder="Filter by station or location…" />
    <div id="regions" class="seg" aria-label="Region">
      <button data-r="all" class="active">All</button>
      <button data-r="wales">Wales</button>
      <button data-r="england">England</button>
      <button data-r="scotland">Scotland</button>
      <button data-r="ireland">Ireland</button>
    </div>
  </div>

  <h3 style="margin:12px 0 8px;color:#ffffffcc">EARLIER</h3>
  <section id="grid" class="grid"></section>

  <div class="pager">
    <button id="prev" class="btn">Prev</button>
    <button id="next" class="btn">Next</button>
  </div>
</div>

<script>
(() => {
  const els = {
    grid: document.getElementById('grid'),
    q: document.getElementById('q'),
    regions: document.getElementById('regions'),
    error: document.getElementById('error'),
    prev: document.getElementById('prev'),
    next: document.getElementById('next'),
  };

  // Helpers
  const relTime = (iso) => {
    if (!iso) return '';
    const t = new Date(iso);
    if (isNaN(t)) return 'Invalid Date';
    const s = Math.floor((Date.now() - t.getTime())/1000);
    if (s < 60) return s + 's ago';
    const m = Math.floor(s/60); if (m < 60) return m + 'm ago';
    const h = Math.floor(m/60); if (h < 24) return h + 'h ago';
    const d = Math.floor(h/24); return d + 'd ago';
  };
  const escapeHtml = s => String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

  // Normalise one archive item.
  // Supports BOTH:
  //   old: { stationName, timeStamp, description, location, website }
  //   new: { shortName, launchDate, title, website, lifeboat_IdNo, _raw }
  function normalize(x){
    // prefer old if present
    let name  = x.stationName || x.shortName || 'Unknown';
    let ts    = x.timeStamp   || x.launchDate || null;
    let desc  = x.description || x.title || '';
    let loc   = x.location || '';
    let site  = x.website || '';

    if (!loc && x.title && x.title.includes(',')) {
      // pull the bit after first comma as location hint
      loc = x.title.split(',').slice(1).join(',').trim();
    }

    // If still empty, look into _raw.title
    if (!loc && x._raw && typeof x._raw.title === 'string' && x._raw.title.includes(',')) {
      loc = x._raw.title.split(',').slice(1).join(',').trim();
    }

    // Coerce blank name if we can recover from title head
    if ((name === 'Unknown' || !name) && x.title && x.title.includes(',')) {
      name = x.title.split(',')[0].trim() || 'Unknown';
    }

    return {
      id: x.id || x.cOACS || Math.random().toString(36).slice(2),
      stationName: name || 'Unknown',
      timeStamp: ts,
      description: desc,
      location: loc,
      website: site
    };
  }

  // State
  let page = Math.max(1, parseInt(new URLSearchParams(location.search).get('page')||'1',10));
  const includeYesterday = (new URLSearchParams(location.search).get('include_yesterday') === '1');
  let region = 'all';
  let items = []; // current page items (normalised)

  function buildURL(){
    const params = new URLSearchParams();
    params.set('page', String(page));
    if (includeYesterday) params.set('include_yesterday','1');
    return 'archive_feed.php?' + params.toString();
  }

  async function load(){
    els.error.style.display='none';
    els.grid.innerHTML = '';
    try{
      const res = await fetch(buildURL(), {cache:'no-cache'});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const raw = Array.isArray(data.items) ? data.items : [];
      items = raw.map(normalize);
      render();
      els.prev.disabled = (page<=1);
      els.next.disabled = (data.total <= page*50 || raw.length===0);
    }catch(e){
      els.error.textContent = 'Failed to load archive: ' + (e.message||e);
      els.error.style.display='block';
    }
  }

  function regionMatch(loc, r){
    if (r==='all') return true;
    const s = String(loc||'').toLowerCase();
    const needle = {
      wales: ['anglesey','gwynedd','conwy','denbighshire','flintshire','wrexham','powys','ceredigion','pembrokeshire','carmarthenshire','swansea','neath port talbot','bridgend','vale of glamorgan','cardiff','rhondda','cynon','taf','merthyr tydfil','caerphilly','blaenau gwent','torfaen','monmouthshire','newport','wales'],
      england: ['england','kent','devon','cornwall','essex','sussex','dorset','somerset','yorkshire','merseyside','tyne','wear','london','lancashire','hampshire','northumberland','cumbria','norfolk','suffolk','lincolnshire'],
      scotland: ['scotland','aberdeenshire','argyll','bute','fife','moray','highland','orkney','shetland'],
      ireland: ['ireland','northern ireland','donegal','wexford','cork','kerry','galway','mayo','louth','down','antrim']
    }[r] || [];
    return needle.some(x => s.includes(x));
  }

  function render(){
    const q = els.q.value.trim().toLowerCase();
    let list = items.filter(it=>{
      const text = [it.stationName,it.description,it.location].join(' ').toLowerCase();
      return (!q || text.includes(q)) && regionMatch(it.location, region);
    });

    if (list.length===0){
      els.grid.innerHTML = '<div class="alert" style="grid-column:1/-1">No launches match your filter.</div>';
      return;
    }

    els.grid.innerHTML = list.map(it=>{
      const when = it.timeStamp ? relTime(it.timeStamp) : 'Invalid Date';
      const mapLink = it.location ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(it.stationName + ' ' + it.location)}" target="_blank" rel="noopener">Map</a>` : '';
      const more = it.website ? `<a href="https://${String(it.website).replace(/^https?:\/\//,'')}" target="_blank" rel="noopener">More</a>` : '';
      return `
        <div class="card">
          <div class="meta"><div>LIFEBOAT</div><div>${escapeHtml(when)}</div></div>
          <div class="title">${escapeHtml(it.stationName || 'Unknown')}</div>
          <div class="desc">${escapeHtml(it.location||'')}</div>
          <div class="row2">
            <div><span class="dot" style="background:#ef4444"></span> Launched (earlier)</div>
            <div class="links">${mapLink}${(mapLink && more)?' · ':''}${more}</div>
          </div>
        </div>`;
    }).join('');
  }

  // Events
  els.q.addEventListener('input', render);
  els.regions.addEventListener('click', e=>{
    const b = e.target.closest('button[data-r]');
    if (!b) return;
    els.regions.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    region = b.dataset.r;
    render();
  });
  els.prev.addEventListener('click', ()=>{ if(page>1){ page--; history.replaceState(null,'',`?page=${page}${includeYesterday?'&include_yesterday=1':''}`); load(); }});
  els.next.addEventListener('click', ()=>{ page++; history.replaceState(null,'',`?page=${page}${includeYesterday?'&include_yesterday=1':''}`); load(); });

  load();
})();
</script>
</body>
</html>