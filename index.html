<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RNLI Live Launch Board</title>
<link rel="icon" href="data:,">
<style>
  :root {
    --bg:#0b0f14; --card:#ffffff10; --border:#ffffff1a; --muted:#ffffff80; --muted2:#ffffff66;
    --brand:#f28b00; --danger:#ef4444; --ok:#22c55e; --amber:#FFD100; --link:#f28b00;
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Helvetica,Arial }
  a{ color:#f28b00; text-decoration:none }
  a:hover{ text-decoration:underline }
  .container{ max-width:1100px; margin:0 auto; padding:24px 16px 48px }

  h1{ margin:0; font-size:clamp(24px,3.2vw,34px); letter-spacing:-0.01em }
  .sub{ color:var(--muted2); margin-top:6px }

  .toolbar{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  /* slightly narrower so the icons fit nicely */
  input[type="text"]{ background:#ffffff0d; border:1px solid var(--border); color:#fff; border-radius:12px; padding:10px 12px; outline:none; min-width:200px }
  input::placeholder{ color:#ffffff55 }
  .btn{ background:#ffffff0d; border:1px solid var(--border); color:#fff; border-radius:12px; padding:10px 12px; cursor:pointer }
  .seg{ display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden }
  .seg button{ background:#ffffff0d; border:0; color:#fff; padding:8px 12px; cursor:pointer }
  .seg button+button{ border-left:1px solid var(--border) }
  .seg .active{ background:#2563eb22; outline:1px solid #2563eb55 }

  /* counts + mismatch badge */
  .seg .count{ opacity:.65; margin-left:6px; font-size:12px }
  .warn-badge{ color:#ef4444; font-weight:700; margin-left:6px }

  /* compact icon buttons (sound + archive) */
  .iconbtn{
    width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;
    border:1px solid var(--border); background:#ffffff0d; color:#fff; border-radius:10px; cursor:pointer;
  }
  .iconbtn:hover{ background:#ffffff12 }
  .iconbtn[aria-pressed="true"]{ outline:1px solid #2563eb55; background:#2563eb22 }
  .iconbtn .ico{ font-size:18px; line-height:1 }

  /* Weather pill */
  .wx{
    display:inline-flex;align-items:center;gap:6px;
    background:#ffffff12;border:1px solid var(--border);
    padding:2px 8px;border-radius:999px;font-size:11px;
    margin-top:5px;opacity:0;transform:translateY(-2px);
    transition:opacity .25s,transform .25s;
  }
  .wx.ready{opacity:1;transform:translateY(0)}
  .wx .ico{font-size:13px;line-height:1}
  .wx .t{font-variant-numeric:tabular-nums}

  .status-active{
    display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600;border: 1px solid #16a34a55;
    background: #16a34a1f;color: #86efac;
  }

  /* Banner (ticker) */
  .banner{
    margin-top:18px; border:1px solid #f59e0b55; background:#f59e0b1a; color:#ffdca8;
    border-radius:14px; padding:12px 40px 12px 14px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    overflow:hidden; box-shadow:0 10px 30px #00000040;
    display:block; position:relative;
  }
  .banner .close{ position:absolute; right:8px; top:6px; background:transparent; color:#ffdca8; border:0; font-size:18px; line-height:1; cursor:pointer; opacity:.7 }
  .banner .close:hover{ opacity:1 }
  .cursor{ display:inline-block; animation: blink 0.6s steps(2,start) infinite }
  @keyframes blink { 50%{opacity:0} }

  .alert{ margin-top:12px; border:1px solid #ef444455; background:#ef44441a; color:#fecaca; padding:10px 12px; border-radius:12px; display:none }

  /* Grid & cards */
  .day{ margin-top:24px }
  .day h2{ margin:0 0 10px; font-size:16px; font-weight:600; color:#cbd5e1; text-transform:uppercase }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:14px; margin-top:12px }

  .boat{font-size:13px;color:#9ca3af;margin-top:2px;display:flex;flex-wrap:wrap;gap:4px}
  .boat .classLink{color:#9ca3af;text-decoration:underline;text-underline-offset:2px}
  .boat .classLink:hover{color:#fff}
  .boat .idNo{flex:0 0 100%}
  .boat .unknown{color:#94a3b8;font-style:italic}

  .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; transition:background .2s }
  .card:hover{ background:#ffffff12 }
  .meta{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start }
  .left{ flex:1 1 0; min-width:0 }
  .rightTop{ flex:0 0 auto; display:flex; flex-direction:column; align-items:flex-end; gap:4px; text-align:right; max-width:45%; font-size:13px; color:#aaa }
  .label{ font-size:12px; text-transform:uppercase; color:#ffffff99; letter-spacing:.06em }
  .title{ margin-top:4px; font-size:18px; font-weight:700 }
  .desc{ margin-top:8px; color:#fff }
  .row2{ margin-top:10px; display:flex; justify-content:space-between; align-items:flex-start; font-size:12px; color:#ffffff99; gap:10px }
  .loc{ flex:1 1 auto; min-width:0; margin-bottom:2px }
  .right{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; text-align:right; max-width:60% }
  .status{ white-space:nowrap; display:flex; align-items:center; gap:8px; margin-top:4px }
  .links{ display:inline-flex; flex-wrap:wrap; gap:12px }

  .dot{ width:10px; height:10px; border-radius:999px; margin-right:5px; display:inline-block; animation:pulse 1.2s infinite }
  @keyframes pulse{ 0%{ transform:scale(.9); opacity:.6 } 70%{ transform:scale(1.2); opacity:1 } 100%{ transform:scale(.9); opacity:.6 } }

  .recent .dot{ background:#22c55e }
  .today  .dot{ background:var(--amber) }
  .older  .dot{ background:#64748b }
  .card.recent{ border-color:#22c55e55 }
  .card.today{  border-color:rgba(255,209,0,.35) }
  .card.older{  border-color:#64748b55 }

  /* highlight cards with no matched region */
  .no-region{ border:2px dashed #ef4444 !important; background:#450a0a33 }

  .empty{ margin-top:24px; padding:16px; text-align:center; color:#94a3b8; font-size:15px }

  footer{ color:#ffffff66; font-size:12px; margin-top:18px }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>RNLI Live Launch Board</h1>
    <div class="sub">Live callouts with a pinned ticker and gentle refresh.</div>
    <div class="toolbar">
      <input id="filter" type="text" placeholder="Search station‚Ä¶" />
      <div class="seg" id="regionSeg">
        <button data-region="ALL" class="active">All <span class="count" id="c_all_live"></span></button>
        <button data-region="WALES">Wales <span class="count" id="c_wales_live"></span></button>
        <button data-region="SCOTLAND">Scotland <span class="count" id="c_scot_live"></span></button>
        <button data-region="ENGLAND">England <span class="count" id="c_eng_live"></span></button>
        <button data-region="IRELAND">Ireland <span class="count" id="c_ire_live"></span></button>
      </div>
      <div class="seg" id="activeSeg">
        <button data-mins="20">20m</button>
        <button data-mins="45" class="active">45m</button>
        <button data-mins="60">60m</button>
      </div>

      <!-- compact icons -->
      <button id="toggleSound" class="iconbtn" aria-pressed="false" title="Sound OFF" aria-label="Sound OFF">
        <span class="ico" id="soundIcon">üîá</span>
      </button>
      <a href="archive.html" class="iconbtn" id="openArchive" style="margin-left:auto" title="Open archive" aria-label="Open archive">
        <span class="ico">üóÇÔ∏è</span>
      </a>
    </div>
  </header>

  <!-- Pinned ticker -->
  <div id="banner" class="banner" role="status" aria-live="polite" aria-atomic="true">
    <button id="closeBanner" class="close" title="Hide">√ó</button>
    <span id="bannerText">SHOUT: <span class="cursor">‚ñå</span></span>
  </div>
  <div id="error" class="alert" role="alert"></div>

  <section id="days"></section>
  <footer>
     Auto-refreshes every 60s. Uses RNLI API via local proxy to avoid CORS.
     <br>¬© Stiwdio Ltd 2025<br>
    <span id="lastUpdate"></span></footer>
</div>

<script src="js/boats.js"></script>
<script src="js/regions.js"></script>
<script>
(() => {
  // Endpoints
  const API_DIRECT = 'https://services.rnli.org/api/launches?numberOfShouts=25';
  const API_PROXY  = 'proxy.php?url=' + encodeURIComponent(API_DIRECT);
  const USE_PROXY_ONLY = true;

  // Elements
  const els = {
    days: document.getElementById('days'),
    banner: document.getElementById('banner'),
    bannerText: document.getElementById('bannerText'),
    closeBanner: document.getElementById('closeBanner'),
    error: document.getElementById('error'),
    filter: document.getElementById('filter'),
    regionSeg: document.getElementById('regionSeg'),
    activeSeg: document.getElementById('activeSeg'),
    toggleSound: document.getElementById('toggleSound'),
    soundIcon: document.getElementById('soundIcon'),
    lastUpdate: document.getElementById('lastUpdate'),
  };

  // State
  let data = [];
  let backoff = 0;
  let nextTimer = null;
  let region = 'ALL';
  let ACTIVE_WINDOW = 45 * 60 * 1000;
  let lastTickerId = null;
  let soundOn = false;

  // Stability helpers
  let isLoading = false;
  let failStreak = 0;

  // Utils
  function relTime(iso){
    if (!iso) return '';
    const s = Math.floor((Date.now() - new Date(iso).getTime())/1000);
    if (s < 60) return s + 's ago';
    const m = Math.floor(s/60); if (m < 60) return m + 'm ago';
    const h = Math.floor(m/60); if (h < 24) return h + 'h ago';
    const d = Math.floor(h/24); return d + 'd ago';
  }
  function dayLabel(iso){
    const d = new Date(iso);
    const today = new Date(); today.setHours(0,0,0,0);
    const that = new Date(d); that.setHours(0,0,0,0);
    const diff = Math.round((today - that) / 86400000);
    if (diff === 0) return 'Today';
    if (diff === 1) return 'Yesterday';
    return 'Earlier';
  }
  function ageClass(iso){
    const h = (Date.now() - new Date(iso).getTime())/3600000;
    if (h < 1) return 'recent';
    if (h < 24) return 'today';
    return 'older';
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // Boat class links
  const CLASS_LINKS = {
    'D-class Inshore':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/d-class-lifeboat',
    'Atlantic (B-class) Inshore':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/b-class-lifeboat',
    'E-class (Thames) Inshore':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/e-class-lifeboat',
    'Hovercraft':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/rescue-hovercraft',
    'Shannon class All-Weather':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/shannon-class-lifeboat',
    'Severn class All-Weather':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/severn-class-lifeboat',
    'Tamar class All-Weather':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/tamar-class-lifeboat',
    'Trent class All-Weather':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/trent-class-lifeboat',
    'Mersey class All-Weather':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/mersey-class-lifeboat',
    'XP-class':'https://rnli.org/what-we-do/lifeboats-and-stations/our-lifeboat-fleet/inshore-rescue-boat'
  };
  function classFromId(op){
    if(!op) return '';
    op=String(op).trim().toUpperCase();
    if(/^D-\d+/.test(op))  return 'D-class Inshore';
    if(/^B-\d+/.test(op))  return 'Atlantic (B-class) Inshore';
    if(/^E-\d+/.test(op))  return 'E-class (Thames) Inshore';
    if(/^H-\d+/.test(op))  return 'Hovercraft';
    if(/^XP-?\d+/.test(op))return 'XP-class';
    if(/^13-\d+/.test(op)) return 'Shannon class All-Weather';
    if(/^17-\d+/.test(op)) return 'Severn class All-Weather';
    if(/^16-\d+/.test(op)) return 'Tamar class All-Weather';
    if(/^14-\d+/.test(op)) return 'Trent class All-Weather';
    if(/^12-\d+/.test(op)) return 'Mersey class All-Weather';
    return '';
  }

  // Build a card
  function cardHTML(l){
    const cls = ageClass(l.timeStamp);
    const noRegClass = (entryRegion(l) ? '' : ' no-region'); // highlight unmatched

    const { idNo, className, classLink } = boatInfo(l);
    let classHtml = className ? escapeHtml(className) : '';
    if (className && classLink) {
      classHtml = '<a href="'+classLink+'" target="_blank" rel="noopener" class="classLink">'+classHtml+'</a>';
    }
    const label  = classHtml || '<span class="unknown">Unclassified</span>';
       const idSpan = idNo ? '<span class="idNo">('+escapeHtml(idNo)+')</span>' : '';
    const boatLine = '<div class="boat">'+label+idSpan+'</div>';

    const link   = l.website ? `<a href="https://${l.website.replace(/^https?:\/\//,'')}" target="_blank" rel="noopener">More</a>` : '';
    const mapsQ  = encodeURIComponent('RNLI '+(l.stationName||''));
    const mapLink = `<a href="https://www.google.com/maps/search/?api=1&query=${mapsQ}" target="_blank" rel="noopener">Map</a>`;

    const active = (Date.now() - new Date(l.timeStamp).getTime()) < ACTIVE_WINDOW;
    const status = active ? 'Active' : (
      dayLabel(l.timeStamp)==='Today' ? 'Launched (today)' :
      dayLabel(l.timeStamp)==='Yesterday' ? 'Launched (yesterday)' : 'Launched (earlier)'
    );

    const wxSpan = `<span data-wx-name="${escapeHtml(l.stationName)}"></span>`;

    return `
      <div class="card ${cls}${noRegClass}">
        <div class="meta">
          <div class="left">
            <div class="label">Lifeboat</div>
            <div class="title">${escapeHtml(l.stationName)}</div>
            ${boatLine}
          </div>
          <div class="rightTop">
            <div>${relTime(l.timeStamp)}</div>
            <div style="color:#666" title="${new Date(l.timeStamp).toISOString()}">${new Date(l.timeStamp).toLocaleTimeString()}</div>
            ${wxSpan}
          </div>
        </div>
        <div class="desc">${escapeHtml(l.description || '')}</div>
        <div class="row2">
          <div class="loc">${escapeHtml(l.location||'')}</div>
          <div class="right">
            <div class="status" aria-label="Status: ${status}">
              <span class="dot" style="margin-right:5px"></span>
              ${status === 'Active' ? `<span class="status-active">${status}</span>` : status}
            </div>
            <div class="links">${mapLink}${link ? ' ¬∑ '+link : ''}</div>
          </div>
        </div>
      </div>`;
  }

  // ‚îÄ‚îÄ‚îÄ Weather helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const WEATHER_TTL = 5 * 60 * 1000;      // cache 5 minutes
  const weatherCache = new Map();
  let stationCoords = {};                  // lowercased: { "barry dock": [lat,lon], ... }

  function iconForWmo(code){
    const c = Number(code);
    if (c===0) return '‚òÄÔ∏è';
    if ([1,2].includes(c)) return 'üå§Ô∏è';
    if (c===3) return '‚òÅÔ∏è';
    if ([45,48].includes(c)) return 'üå´Ô∏è';
    if ((c>=51 && c<=67) || [80,81,82].includes(c)) return 'üåßÔ∏è';
    if (c>=71 && c<=86) return '‚ùÑÔ∏è';
    if ([95,96,99].includes(c)) return '‚õàÔ∏è';
    return 'üå°Ô∏è';
  }

  async function fetchWeatherFor(name, lat, lon){
    const cached = weatherCache.get(name);
    if (cached && Date.now() - cached.ts < WEATHER_TTL) return cached;

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&wind_speed_unit=kn&timezone=auto`;
    const res = await fetch(url, { cache:'no-cache' });
    if (!res.ok) throw new Error('weather http '+res.status);
    const j = await res.json();
    const cur = j.current || j.current_weather || {};
    const out = {
      icon: iconForWmo(cur.weather_code ?? cur.weathercode ?? 0),
      temp: cur.temperature_2m ?? cur.temperature ?? null,
      wind: cur.wind_speed_10m ?? cur.windspeed ?? null,
      ts: Date.now()
    };
    weatherCache.set(name, out);
    return out;
  }

  // Load coords and hydrate immediately (fixes slow first paint)
  async function loadStationCoords(){
    try{
      const r = await fetch('stations_geo.json', { cache:'no-cache' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();

      // lowercased lookup for robust matching
      stationCoords = {};
      Object.keys(j || {}).forEach(k=>{
        stationCoords[String(k).trim().toLowerCase()] = j[k];
      });

      // hydrate instantly when coords are ready
      mountWeatherForVisibleCards();
    }catch(e){
      stationCoords = {};
      console.warn('[wx] stations_geo.json not loaded:', e.message || e);
    }
  }

  // Hydrate pills for any visible cards
  function mountWeatherForVisibleCards(){
    const keys = Object.keys(stationCoords || {});
    if (!keys.length) return;

    document.querySelectorAll('[data-wx-name]').forEach(el=>{
      const raw = el.getAttribute('data-wx-name') || '';
      const coords = coordsForStation(raw);
      if (!coords) return;

      el.innerHTML = '<span class="wx"><span class="ico">‚Ä¶</span><span class="t">‚Ä¶</span></span>';
      fetchWeatherFor(raw, coords[0], coords[1]).then(w=>{
        const t  = (w.temp != null) ? Math.round(Number(w.temp)) : null;
        const ws = (w.wind != null) ? Math.round(Number(w.wind)) : null;
        el.innerHTML =
          `<span class="wx ready"><span class="ico">${w.icon}</span>`+
          `<span class="t">${t ?? '‚Äî'}¬∞C${ws!=null ? ' ¬∑ '+ws+' kn' : ''}</span></span>`;
      }).catch(()=>{ el.textContent=''; });
    });
  }

  // Helpers for robust coord lookup
  function coordsForStation(name){
    if (!name) return null;
    const lc = s => String(s).trim().toLowerCase();

    const base = lc(name);
    const tries = new Set([base]);

    // strip parentheses: "Llandudno (Ormes Head)" -> "Llandudno"
    const noParens = base.replace(/\s*\([^)]*\)\s*/g, ' ').replace(/\s+/g,' ').trim();
    tries.add(noParens);

    // drop leading "the "
    if (noParens.startsWith('the ')) tries.add(noParens.slice(4));

    // St. ‚Üî St variations
    tries.add(noParens.replace(/\bst\.\s/g, 'st '));
    tries.add(noParens.replace(/\bst\s/g, 'st. '));

    // (Isle of Wight) ‚Üî (IOW)
    tries.add(noParens.replace(/\(isle of wight\)/g, '(iow)'));
    tries.add(noParens.replace(/\(iow\)/g, '(isle of wight)'));

    for (const key of tries){
      if (stationCoords && stationCoords[key]) return stationCoords[key];
    }
    return null;
  }

  // ---- Ticker helpers ----
  function typeTicker(rest){
    const prefix = 'SHOUT: ';
    const full   = prefix + (rest || '');
    let i = prefix.length;
    const cursor = '<span class="cursor">‚ñå</span>';
    els.bannerText.innerHTML = prefix + cursor;

    const iv = setInterval(()=>{
      i++;
      const chunk = escapeHtml(full.slice(0, i));
      els.bannerText.innerHTML = chunk + ' ' + cursor;
      if (i >= full.length){
        clearInterval(iv);
        els.bannerText.innerHTML = escapeHtml(full) + ' ' + cursor;
      }
    }, 18);
  }
  function setTickerText(rest){
    const prefix = 'SHOUT: ';
    const cursor = '<span class="cursor">‚ñå</span>';
    els.bannerText.innerHTML = escapeHtml(prefix + (rest||'')) + ' ' + cursor;
  }

  // Normalise RNLI API ‚Üí our fields
  function normalize(list){
    if (!Array.isArray(list)) return [];
    return list.map(x=>({
      id: x.id || x.cOACS || Math.random().toString(36).slice(2),
      stationName: x.shortName || 'Unknown',
      timeStamp: x.launchDate || new Date().toISOString(),
      description: x.title || '',
      location: (x.title||'').includes(',') ? (x.title||'').split(',').slice(1).join(',').trim() : '',
      website: x.website || '',
      lifeboat_IdNo: x.lifeboat_IdNo || ''
    }));
  }

  async function fetchCleanJSON(){
    const url = USE_PROXY_ONLY ? API_PROXY : API_DIRECT;
    const res = await fetch(url, { cache:'no-cache', redirect:'follow' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  // Region button visibility + counts + mismatch badge
  function updateRegionButtonsFor(list){
    const counts = {
      ALL: list.length,
      WALES:    list.filter(l => entryRegion(l)==='WALES').length,
      SCOTLAND: list.filter(l => entryRegion(l)==='SCOTLAND').length,
      ENGLAND:  list.filter(l => entryRegion(l)==='ENGLAND').length,
      IRELAND:  list.filter(l => entryRegion(l)==='IRELAND').length
    };

    // write numbers
    const byId = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v || ''; };
    byId('c_all_live',  counts.ALL);
    byId('c_wales_live',counts.WALES);
    byId('c_scot_live', counts.SCOTLAND);
    byId('c_eng_live',  counts.ENGLAND);
    byId('c_ire_live',  counts.IRELAND);

    // hide empty (except All)
    ['WALES','SCOTLAND','ENGLAND','IRELAND'].forEach(key=>{
      const btn = els.regionSeg.querySelector('button[data-region="'+key+'"]');
      if (btn) btn.style.display = counts[key]===0 ? 'none' : '';
    });

    // mismatch badge on All (unknown regions present)
    const sumRegions = counts.WALES + counts.SCOTLAND + counts.ENGLAND + counts.IRELAND;
    const diff = counts.ALL - sumRegions;
    const allBtn = els.regionSeg.querySelector('button[data-region="ALL"]');
    if (allBtn){
      const old = allBtn.querySelector('.warn-badge');
      if (old) old.remove();
      if (diff !== 0){
        const b = document.createElement('span');
        b.className = 'warn-badge';
        b.textContent = `‚ö† ${diff}`;
        allBtn.appendChild(b);

        // console list the unknowns (helps update regions.js)
        const unknowns = list.filter(l => !['WALES','SCOTLAND','ENGLAND','IRELAND'].includes(entryRegion(l)));
        if (unknowns.length){
          console.warn('Unmatched stations (live):', unknowns.map(u => u.stationName));
        }
      }
    }
  }

  // Render board
  function render(){
    const q = (els.filter.value||'').trim().toLowerCase();
    const all = data.slice().sort((a,b)=> new Date(b.timeStamp) - new Date(a.timeStamp));

    // Live shows only Today + Yesterday
    let base = all.filter(l => {
      const d = dayLabel(l.timeStamp);
      return d === 'Today' || d === 'Yesterday';
    });

    // Text filter
    if (q) base = base.filter(l => [l.stationName, l.description, l.location].some(v => (v||'').toLowerCase().includes(q)));

    // Update region buttons based on pre-region list
    updateRegionButtonsFor(base);

    // Apply region selection
    const list = (region === 'ALL') ? base : base.filter(l => entryRegion(l) === region);

    // Group + render
    const groups = { Today:[], Yesterday:[] };
    for (const item of list){ groups[dayLabel(item.timeStamp)]?.push(item); }

    const html = ['Today','Yesterday'].map(label=>{
      const items = groups[label] || [];
      if (!items.length) return '';
      const cards = items.map(cardHTML).join('');
      return `<section class="day"><h2>${label}</h2><div class="grid">${cards}</div></section>`;
    }).join('');

    els.days.innerHTML = html || `<div class="empty">No launches match your filter.</div>`;

    // hydrate weather pills for the freshly-rendered cards
    mountWeatherForVisibleCards();
  }

  // Sound ping
  let audioCtx = null;
  function ping(){
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=880; g.gain.value=0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.2, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.3);
      o.start(); o.stop(now+0.35);
    }catch(e){}
  }

  // Ticker
  function ensureFirstSeenFor(list){
    if (!list.length) return;
    const h = list[0];
    if (h && h.id !== lastTickerId){
      lastTickerId = h.id;
      const rest = `${h.stationName} ‚Äî ${new Date(h.timeStamp).toLocaleString()}${h.description ? ' ' + h.description : ''}`;
      typeTicker(rest);
      if (soundOn) ping();
    }
  }

  // Load loop
  async function load(){
    if (isLoading) return;
    isLoading = true;
    els.error.style.display='none';
    try{
      const raw = await fetchCleanJSON();
      const mapped = normalize(raw);
      if (window.logUnknownBoatClasses) logUnknownBoatClasses(mapped);
      if (window.logUnmatchedRegions) logUnmatchedRegions(mapped);

      ensureFirstSeenFor(mapped);
      data = mapped;
      render();
      els.lastUpdate.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
      failStreak = 0;

      try { localStorage.setItem('lastGoodData', JSON.stringify(mapped)); } catch(e){}

      scheduleNext(true);
    }catch(err){
      const name = (err && err.name) ? String(err.name) : '';
      const msg  = (err && err.message) ? String(err.message) : String(err);

      if (/AbortError/i.test(name) || /aborted/i.test(msg)) { scheduleNext(false); isLoading=false; return; }

      const fallback = (()=>{ try { return JSON.parse(localStorage.getItem('lastGoodData')||'null'); } catch(e){ return null; } })();
      if (fallback && Array.isArray(fallback)){
        data = fallback;
        render();
      }
      if (++failStreak >= 2){
        els.error.textContent = 'Fetch failed, showing last good data ‚Äî ' + msg;
        els.error.style.display='block';
        setTickerText('Showing last good data ‚Äî reconnecting‚Ä¶');
      }
      scheduleNext(false);
    } finally {
      isLoading = false;
    }
  }

  function scheduleNext(ok){
    if (nextTimer) { clearTimeout(nextTimer); nextTimer = null; }
    if (ok){
      backoff = 0;
      nextTimer = setTimeout(load, 30*1000);
    }else{
      backoff = Math.min(backoff ? backoff*2 : 10*1000, 5*60*1000);
      nextTimer = setTimeout(load, backoff);
    }
  }

  // Events
  els.filter.addEventListener('input', render);

  els.regionSeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-region]');
    if (!b) return;
    els.regionSeg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    region = b.dataset.region || 'ALL';
    render();
  });

  els.activeSeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-mins]');
    if (!b) return;
    els.activeSeg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    ACTIVE_WINDOW = parseInt(b.dataset.mins,10) * 60 * 1000;
    render();
  });

  function updateSoundButton(){
    els.soundIcon.textContent = soundOn ? 'üîä' : 'üîá';
    els.toggleSound.setAttribute('aria-pressed', soundOn ? 'true' : 'false');
    els.toggleSound.title = 'Sound ' + (soundOn ? 'ON' : 'OFF');
    els.toggleSound.setAttribute('aria-label', 'Sound ' + (soundOn ? 'ON' : 'OFF'));
  }

  els.toggleSound.addEventListener('click', async ()=>{
    soundOn = !soundOn;
    updateSoundButton();
    try {
      if (!audioCtx && soundOn) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
      } else if (audioCtx && soundOn) {
        await audioCtx.resume();
      }
    } catch(e){}
  });

  els.closeBanner.addEventListener('click', ()=>{ els.banner.style.display='none'; });

  // ---------- BOOT ----------
  (function bootFromCache(){
    try{
      const cached = localStorage.getItem('lastGoodData');
      if (cached){
        const parsed = JSON.parse(cached);
        if (Array.isArray(parsed) && parsed.length){
          data = parsed;
          if (window.logUnmatchedRegions) logUnmatchedRegions(parsed);
          render();
          els.lastUpdate.textContent = 'Last updated (cached): ' + new Date().toLocaleTimeString();
        }
      }
    }catch(e){}
  })();

  // Start live loop
  loadStationCoords();   // load coords and hydrate immediately
  render();              // paint UI quickly
  updateSoundButton();   // set initial icon state
  load();                // begin live fetch loop
})();
</script>
</body>
</html>