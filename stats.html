<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RNLI Stats</title>
<link rel="icon" href="data:,">
<style>
  :root{--bg:#0b0f14;--card:#ffffff10;--border:#ffffff1a;--muted:#ffffff80;--muted2:#ffffff66;--rnli:#f28b00}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Helvetica,Arial}
  a{color:var(--rnli)}
  .container{max-width:1200px;margin:0 auto;padding:24px 16px 48px}
  h1{margin:0;font-size:34px;letter-spacing:-0.01em}
  .sub{color:var(--muted2);margin-top:6px}
  .type{margin-top:10px;color:#cbd5e1;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .label{color:#ffffff99;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
  .big{font-size:40px;font-weight:800;letter-spacing:.02em}
  .pill{display:inline-block;padding:6px 12px;border:1px solid var(--border);border-radius:999px;margin:6px 8px 0 0}
  .list{margin:8px 0 0;padding:0;list-style:none}
  .list li{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-top:1px solid #ffffff12}
  .spark{height:46px}
  .nowrap{white-space:nowrap}
  /* Stations panel */
  .stn-toolbar{display:flex;gap:8px;align-items:center;margin:8px 0}
  .stn-seg{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .stn-seg button{background:#ffffff0d;border:0;color:#fff;padding:6px 10px;cursor:pointer}
  .stn-seg button+button{border-left:1px solid var(--border)}
  .stn-seg .active{background:#2563eb22;outline:1px solid #2563eb55}
  .stn-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .stn-item{display:flex;justify-content:space-between;gap:12px;border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:#ffffff10}
  .stn-item .name{overflow:hidden;text-overflow:ellipsis}
  input.search{background:#ffffff0d;border:1px solid var(--border);color:#fff;border-radius:10px;padding:6px 10px;flex:1;min-width:160px}
</style>
</head>
<body>
<div class="container">
  <h1>RNLI Stats</h1>
  <div class="sub">Live aggregates from the growing archive.</div>
  <div id="type" class="type"></div>

  <div class="grid">
    <div class="card">
      <div class="label">Total launches</div>
      <div id="total" class="big">0</div>
      <div class="label" style="margin-top:10px">By region</div>
      <div id="regions" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="label">By class</div>
      <ul id="classes" class="list"></ul>
    </div>

    <div class="card">
      <div class="label">Top stations</div>
      <ul id="stationsTop" class="list"></ul>
    </div>

    <div class="card">
      <div class="label">Launches by hour (UTC)</div>
      <canvas id="byHour" class="spark"></canvas>
      <div class="label" style="margin-top:10px">Last 7 days</div>
      <canvas id="last7" class="spark"></canvas>
    </div>

    <!-- ALL STATIONS -->
    <div class="card" id="stationsCard">
      <div class="label">All stations</div>
      <div class="stn-toolbar">
        <div class="stn-seg" id="stnSeg">
          <button data-r="all" class="active">All</button>
          <button data-r="wales">Wales</button>
          <button data-r="scotland">Scotland</button>
          <button data-r="england">England</button>
          <button data-r="ireland">Ireland</button>
        </div>
        <input id="stnSearch" class="search" placeholder="Filter by name…">
      </div>
      <div class="stn-grid" id="stnGrid"></div>
    </div>
  </div>
</div>

<script>
// ---------- Data fetchers ----------
async function fetchStats(){
  const res = await fetch('stats_feed.php?live=1&ts=' + Date.now(), {cache:'no-cache'});
  const text = await res.text();
  if (!res.ok) throw new Error('HTTP '+res.status+': '+text.slice(0,120));
  if (!text.trim()) throw new Error('Empty response from stats_feed.php');
  try { return JSON.parse(text); } catch(e){ throw new Error('Bad JSON: '+e.message+' • '+text.slice(0,120)); }
}

// Optional canonical stations list (to show 0s). If missing, we’ll just use seen stations.
async function fetchStationsMaster(){
  try{
    const r = await fetch('data/stations.json', {cache:'no-cache'});
    if (!r.ok) throw new Error(String(r.status));
    return r.json();
  }catch(e){
    return null; // fallback will use current counts only (no zeros)
  }
}

// ---------- Tiny helpers ----------
function odometer(el, to){
  const start = Number(el.textContent.replace(/\D/g,'')) || 0;
  const dur = 600; const t0 = performance.now();
  function step(t){
    const p = Math.min(1,(t-t0)/dur);
    el.textContent = Math.round(start + (to-start)*p).toLocaleString();
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function typewriter(el, text){
  let i=0; el.textContent='';
  const iv = setInterval(()=>{ el.textContent = text.slice(0, ++i); if(i>=text.length) clearInterval(iv); }, 18);
}
function drawBars(listEl, obj){
  const total = Object.values(obj).reduce((a,b)=>a+b,0) || 1;
  const entries = Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,10);
  listEl.innerHTML = entries.map(([k,v])=>{
    const pct = Math.round(100*v/total);
    return `<li><span class="nowrap">${k}</span><span>${v.toLocaleString()} · ${pct}%</span></li>`;
  }).join('');
}
function drawByRegion(container, regions){
  const order = ['wales','scotland','england','ireland','other'];
  container.innerHTML = order.filter(k=>regions[k]!==undefined).map(k=>{
    const v = regions[k]; const name = k[0].toUpperCase()+k.slice(1);
    return `<span class="pill">${name}: ${v}</span>`;
  }).join(' ');
}
function drawSpark(canvas, arr){
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.clientWidth, h = canvas.height = canvas.clientHeight;
  const max = Math.max(...arr,1);
  ctx.clearRect(0,0,w,h);
  ctx.beginPath();
  arr.forEach((v,i)=>{
    const x = (i/(arr.length-1 || 1)) * (w-2) + 1;
    const y = h - (v/max)*(h-6) - 3;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#f59e0b';
  ctx.lineWidth = 2; ctx.stroke();
}

function renderStations(allStations, byStationCounts, regionFilter='all', q=''){
  const grid = document.getElementById('stnGrid');
  const normQ = q.trim().toLowerCase();

  // Merge master list with counts (default 0)
  let merged = [];
  if (Array.isArray(allStations) && allStations.length){
    merged = allStations.map(s => ({
      name: s.name,
      region: (s.region||'other').toLowerCase(),
      count: byStationCounts[s.name] || 0
    }));
  }
  // Also include any stations seen in data but not in master
  Object.keys(byStationCounts).forEach(name=>{
    if(!merged.find(m=>m.name===name)){
      merged.push({name, region:'other', count:byStationCounts[name]});
    }
  });

  const filtered = merged
    .filter(s => regionFilter==='all' ? true : s.region===regionFilter)
    .filter(s => !normQ || s.name.toLowerCase().includes(normQ))
    .sort((a,b)=> b.count - a.count || a.name.localeCompare(b.name));

  grid.innerHTML = filtered.map(s => `
    <div class="stn-item">
      <span class="name nowrap" title="${s.name}">${s.name}</span>
      <span>${s.count}</span>
    </div>
  `).join('') || `<div class="empty" style="margin-top:8px;color:#94a3b8">No stations</div>`;
}

// ---------- Boot ----------
(async function(){
  const [stats, stationsMaster] = await Promise.all([fetchStats(), fetchStationsMaster()]);
  if(!stats.ok){ document.body.innerHTML = '<div style="padding:24px">Stats not available.<br>'+ (stats.error||'') +'</div>'; return; }

  // Headline
  const daysSpan = Math.max(1, Math.round((new Date(stats.meta.last)-new Date(stats.meta.first))/86400000));
  typewriter(document.getElementById('type'),
    `Tracking ${stats.meta.count.toLocaleString()} launches (archive + live) over the last ${daysSpan} days…`);

  // Totals + regions
  odometer(document.getElementById('total'), stats.meta.count);
  drawByRegion(document.getElementById('regions'), stats.stats.by_region);

  // Class + top stations
  drawBars(document.getElementById('classes'),  stats.stats.by_class);
  drawBars(document.getElementById('stationsTop'), stats.stats.top_stations);

  // Series
  drawSpark(document.getElementById('byHour'), stats.stats.by_hour);
  drawSpark(document.getElementById('last7'), stats.stats.last_7_days.map(d=>d.count));

  // All stations panel (with 0s if stations.json exists)
  let r = 'all', q = '';
  const byStation = stats.stats.by_station || {};
  renderStations(stationsMaster||[], byStation, r, q);

  const stnSeg = document.getElementById('stnSeg');
  const stnSearch = document.getElementById('stnSearch');
  stnSeg.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-r]'); if(!b) return;
    stnSeg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); r = b.dataset.r;
    renderStations(stationsMaster||[], byStation, r, q);
  });
  stnSearch.addEventListener('input', ()=>{
    q = stnSearch.value;
    renderStations(stationsMaster||[], byStation, r, q);
  });
})();
</script>
</body>
</html>